# Name of the workflow as it appears in the GitHub Actions UI
name: Build ARM64 Docker Image and Create Pre-Release

on:
  workflow_dispatch:
    branches:
      - release

# Define jobs for the workflow
jobs:
  bump_version:
    name: Bump version
    runs-on: [ubuntu-latest]
    outputs:
      tag: ${{ steps.generate_tag.outputs.tag }}

    steps:
      - name: Check out branch
        uses: actions/checkout@v4
        # https://github.com/actions/checkout
        with:
          ref: release
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Bump version and generate tag
        uses: TriPSs/conventional-changelog-action@v5
        # https://github.com/TriPSs/conventional-changelog-action
        id: generate_tag
        with:
          version-file: ./src/version.json
          github-token: ${{ secrets.GITHUB_TOKEN }}
          release-count: 10

  build-and-push-arm64:
    name: Build and Push ARM64 Image
    runs-on: [ubuntu-latest]
    needs: [bump_version]

    # Permissions needed for the job
    permissions:
      contents: read # To checkout the repository code
      packages: write # To publish packages to GitHub Container Registry

    # Outputs to pass to the next job
    outputs:
      image_sha: ${{ steps.build.outputs.digest }}
      image_tags: ${{ steps.meta.outputs.tags }}

    steps:
      - name: Free runner disk space
        run: |
          sudo rm -rf /usr/share/dotnet \
                      /usr/local/lib/android \
                      /opt/ghc \
                      "$AGENT_TOOLSDIRECTORY"
                      /opt/hostedtoolcache
          docker image prune -af || true
          docker builder prune -af || true
          df -h

      # Step 1: Checkout the repository code
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.bump_version.outputs.tag }}
          lfs: true

      # Step 2: Set up QEMU for multi-platform builds
      # This enables building images for different architectures (like ARM64)
      # on an x86-64 runner.
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      # Step 3: Set up Docker Buildx
      # Buildx is a Docker CLI plugin that extends the docker build command
      # with powerful capabilities like building for multiple platforms, caching, etc.
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Step 4: Log in to GitHub Container Registry (GHCR)
      # Uses the GITHUB_TOKEN to authenticate with GHCR
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }} # The GitHub username of the person who triggered the workflow
          password: ${{ secrets.GITHUB_TOKEN }} # The GitHub token provided by the workflow context

      # Step 5: Extract metadata (tags, labels) for the Docker image
      # This step helps in generating consistent image tags.
      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }} # The base image name for GHCR
          tags: |
            # Always assign 'latest' tag for release builds
            type=raw,value=latest
            # Tag with the actual release version (e.g., 'v0.7.1')
            type=raw,value=${{ needs.bump_version.outputs.tag }},enable=true
            type=sha,format=long # Tag with the full Git SHA

      # Step 6: Build and Push the ARM64 Docker Image
      # This is the core step where the image is built and pushed to GHCR.
      - name: Build and Push Docker Image
        id: build
        uses: docker/build-push-action@v6
        with:
          context: . # The build context (where your Dockerfile is located, usually the root of the repo)
          file: ./Dockerfile # Path to your Dockerfile (default is './Dockerfile')
          platforms: linux/arm64 # Specify the target platform as ARM64
          push: ${{ github.event_name != 'pull_request' }} # Only push on push events, not PRs
          tags: ${{ steps.meta.outputs.tags }} # Use the tags generated by the metadata action
          labels: ${{ steps.meta.outputs.labels }} # Apply labels generated by the metadata action
          cache-from: type=gha # Enable caching using GitHub Actions cache
          cache-to: type=gha,mode=max # Store build cache to GitHub Actions cache

  create_pre_release:
    name: Create pre-release
    runs-on: [ubuntu-latest]
    needs: [build-and-push-arm64, bump_version]

    steps:
      - name: Check out tag
        uses: actions/checkout@v4
        # https://github.com/actions/checkout
        with:
          ref: ${{ needs.bump_version.outputs.tag }}

      - name: Prepare release body with Docker image info
        run: |
          echo "## ðŸ³ Docker Image Information" > release_body.md
          echo "" >> release_body.md
          echo "**ARM64 Docker Image SHA:** \`${{ needs.build-and-push-arm64.outputs.image_sha }}\`" >> release_body.md
          echo "" >> release_body.md
          echo "**Available Tags:**" >> release_body.md
          echo '${{ needs.build-and-push-arm64.outputs.image_tags }}' | tr ',' '\n' | sed 's/^/- `/' | sed 's/$/`/' >> release_body.md
          echo "" >> release_body.md
          echo "**Pull the image:**" >> release_body.md
          echo '```bash' >> release_body.md
          echo "# Using SHA (recommended for reproducible builds)" >> release_body.md
          echo "docker pull ghcr.io/${{ github.repository }}@${{ needs.build-and-push-arm64.outputs.image_sha }}" >> release_body.md
          echo "" >> release_body.md
          echo "# Using latest tag" >> release_body.md
          echo "docker pull ghcr.io/${{ github.repository }}:latest" >> release_body.md
          echo '```' >> release_body.md
          echo "" >> release_body.md
          echo "---" >> release_body.md
          echo "" >> release_body.md
          
          # Append the original changelog if it exists
          if [ -f ./CHANGELOG.md ]; then
            cat ./CHANGELOG.md >> release_body.md
          fi

      - name: Create pre-release
        uses: softprops/action-gh-release@v2
        # https://github.com/softprops/action-gh-release
        with:
          body_path: ./release_body.md
          prerelease: true
          tag_name: ${{ needs.bump_version.outputs.tag }}
